---
import Layout from '../layouts/Layout.astro';
import BookingSection from '../components/BookingSection.astro';
import { supabase } from '../lib/supabase';

let mensajeError = "";

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const nombre = formData.get('nombre') as string;
  const apellido = formData.get('apellido') as string;
  const fecha = formData.get('fecha') as string;
  const hora = formData.get('hora') as string;
  const telefono = formData.get('telefono') as string;

  const diaSemana = new Date(fecha + 'T00:00:00').getDay();
  // Parseamos hora y minutos para validaciones
  const [horaStr, minStr] = hora.split(':');
  const horaNum = parseInt(horaStr);

  try {
    let esHorarioValido = false;

    // --- 1. REGLA DE TIEMPO (AHORA EXACTO) ---
    const ahora = new Date();
    
    // SOLUCI칍N AL ERROR DE HORA:
    // Agregamos "-03:00" al final para decirle al servidor que esta fecha es de Argentina.
    // As칤, si el servidor est치 en Londres (UTC), har치 la conversi칩n matem치tica correcta.
    const fechaTurno = new Date(`${fecha}T${hora}:00-03:00`);

    // Validamos que el turno no sea en el pasado
    if (fechaTurno < ahora) {
         throw { message: "No puedes reservar en un horario que ya pas칩." };
    }

    // --- 2. REGLAS DE D칈AS Y HORARIOS ---
    if (diaSemana === 0) {
        mensajeError = "Los domingos permanecemos cerrados.";
    } 
    else if (diaSemana === 1 || diaSemana === 3 || diaSemana === 5) { // L-M-V (10 a 19)
        if (horaNum >= 10 && (horaNum < 19 || (horaNum === 19 && minStr === '00'))) {
            esHorarioValido = true;
        } else {
            mensajeError = "Los Lun, Mie y Vie abrimos de 10:00 a 19:00.";
        }
    } 
    else if (diaSemana === 2 || diaSemana === 4) { // M-J (10 a 20)
        if (horaNum >= 10 && (horaNum < 20 || (horaNum === 20 && minStr === '00'))) {
            esHorarioValido = true;
        } else {
            mensajeError = "Los Mar y Jue abrimos de 10:00 a 20:00.";
        }
    } 
    else if (diaSemana === 6) { // SAB (11 a 21)
        if (horaNum >= 11 && (horaNum < 21 || (horaNum === 21 && minStr === '00'))) {
            esHorarioValido = true;
        } else {
            mensajeError = "Los S치bados abrimos de 11:00 a 21:00.";
        }
    }

    if (esHorarioValido && !mensajeError) {
        // Consultar disponibilidad exacta
        const { data: turnosExistentes, error: errorSelect } = await supabase
            .from('turnos')
            .select('*')
            .eq('fecha', fecha)
            .eq('hora', hora);

        if (errorSelect) throw errorSelect;

        if (turnosExistentes && turnosExistentes.length > 0) {
            mensajeError = `El horario de las ${hora} ya est치 ocupado.`;
        } else {
            const { error: errorInsert } = await supabase
                .from('turnos')
                .insert([{ nombre, apellido, fecha, hora, telefono }]);

            if (errorInsert) throw errorInsert;
            
            return Astro.redirect(`/exito?nombre=${nombre}&fecha=${fecha}&hora=${hora}`);
        }
    }

  } catch (error: any) {
    console.error("Error:", error);
    mensajeError = error.message || "Error al procesar el turno.";
  }
}
---

<Layout title="Reservar Turno | Ezequiel Marin">
    <main class="app-wrapper">
        <div class="brand-header">
            <h1>BARBER칈A EZEQUIEL MARIN</h1>
            <p>Reserva tu lugar exclusivo</p>
        </div>

        <BookingSection errorBackend={mensajeError} />
        
        <footer class="mini-footer">
            <p>춸 2024 Ezequiel Marin</p>
            <a href="/login" class="admin-link">游</a>
        </footer>
    </main>
</Layout>

<style>
    .app-wrapper { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: var(--color-text-black); padding: 20px; }
    .brand-header { text-align: center; margin-bottom: 30px; color: var(--color-bg-beige); }
    .brand-header h1 { font-family: var(--font-titles); font-size: 2.5rem; letter-spacing: 2px; margin: 0; }
    .brand-header p { font-size: 0.9rem; opacity: 0.7; margin-top: 5px; text-transform: uppercase; letter-spacing: 1px; }
    .mini-footer { margin-top: 40px; text-align: center; color: rgba(242, 240, 230, 0.3); font-size: 0.8rem; }
    .admin-link { text-decoration: none; color: inherit; font-size: 0.8rem; margin-top: 5px; display: inline-block; opacity: 0.5; }
</style>