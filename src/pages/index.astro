---
import Layout from '../layouts/Layout.astro';
import BookingSection from '../components/BookingSection.astro';
import { supabase } from '../lib/supabase';
// Importamos la config de servicios para validar (seguridad extra)
import { servicios } from '../config/servicios';

let mensajeError = "";

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const nombre = formData.get('nombre') as string;
  const apellido = formData.get('apellido') as string;
  const fecha = formData.get('fecha') as string;
  const hora = formData.get('hora') as string;
  const telefono = formData.get('telefono') as string;
  const servicioId = formData.get('servicio') as string; // Recibimos el ID (ej: 'corte')

  const diaSemana = new Date(fecha + 'T00:00:00').getDay();
  const [horaStr, minStr] = hora.split(':');
  const horaNum = parseInt(horaStr);

  try {
    // --- 0. VALIDAR SERVICIO ---
    const servicioEncontrado = servicios.find(s => s.id === servicioId);
    if (!servicioEncontrado) {
        throw { message: "Por favor selecciona un servicio v√°lido." };
    }
    // Guardamos el nombre bonito (ej: "Corte + Barba") en vez del ID
    const nombreServicio = servicioEncontrado.nombre;

    // --- 1. REGLA DE TIEMPO ---
    const ahora = new Date();
    const fechaTurno = new Date(`${fecha}T${hora}:00-03:00`);

    if (fechaTurno < ahora) {
         throw { message: "No puedes reservar en un horario que ya pas√≥." };
    }

    // --- 2. REGLAS DE D√çAS Y HORARIOS ---
    let esHorarioValido = false;
    
    if (diaSemana === 0) mensajeError = "Domingos cerrado.";
    else if ([1, 3, 5].includes(diaSemana)) { // L-M-V
        if (horaNum >= 10 && (horaNum < 19 || (horaNum === 19 && minStr === '00'))) esHorarioValido = true;
        else mensajeError = "Lunes, Mi√©rcoles y Viernes: 10 a 19hs.";
    } 
    else if ([2, 4].includes(diaSemana)) { // M-J
        if (horaNum >= 10 && (horaNum < 20 || (horaNum === 20 && minStr === '00'))) esHorarioValido = true;
        else mensajeError = "Martes y Jueves: 10 a 20hs.";
    } 
    else if (diaSemana === 6) { // SAB
        if (horaNum >= 11 && (horaNum < 21 || (horaNum === 21 && minStr === '00'))) esHorarioValido = true;
        else mensajeError = "S√°bados: 11 a 21hs.";
    }

    if (esHorarioValido && !mensajeError) {
        const { data: turnosExistentes, error: errorSelect } = await supabase
            .from('turnos')
            .select('*')
            .eq('fecha', fecha)
            .eq('hora', hora);

        if (errorSelect) throw errorSelect;

        if (turnosExistentes && turnosExistentes.length > 0) {
            mensajeError = `El horario de las ${hora} ya est√° ocupado.`;
        } else {
            // INSERTAMOS TAMBI√âN EL SERVICIO
            const { error: errorInsert } = await supabase
                .from('turnos')
                .insert([{ 
                    nombre, 
                    apellido, 
                    fecha, 
                    hora, 
                    telefono,
                    servicio: nombreServicio // Guardamos "Corte de Pelo"
                }]);

            if (errorInsert) throw errorInsert;
            
            return Astro.redirect(`/exito?nombre=${nombre}&fecha=${fecha}&hora=${hora}`);
        }
    }

  } catch (error: any) {
    console.error("Error:", error);
    mensajeError = error.message || "Error al procesar el turno.";
  }
}
---

<Layout title="Reservar Turno | Ezequiel Marin">
    <main class="app-wrapper">
        <div class="brand-header">
            <h1>BARBER√çA EZEQUIEL MARIN</h1>
            <p>Reserva tu lugar exclusivo</p>
        </div>

        <BookingSection errorBackend={mensajeError} />
        
        <footer class="mini-footer">
            <p>¬© 2024 Ezequiel Marin</p>
            <a href="/login" class="admin-link">üîí</a>
        </footer>
    </main>
</Layout>

<style>
    /* ... (Estilos iguales) ... */
    .app-wrapper { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: var(--color-text-black); padding: 20px; }
    .brand-header { text-align: center; margin-bottom: 30px; color: var(--color-bg-beige); }
    .brand-header h1 { font-family: var(--font-titles); font-size: 2.5rem; letter-spacing: 2px; margin: 0; }
    .brand-header p { font-size: 0.9rem; opacity: 0.7; margin-top: 5px; text-transform: uppercase; letter-spacing: 1px; }
    .mini-footer { margin-top: 40px; text-align: center; color: rgba(242, 240, 230, 0.3); font-size: 0.8rem; }
    .admin-link { text-decoration: none; color: inherit; font-size: 0.8rem; margin-top: 5px; display: inline-block; opacity: 0.5; }
</style>