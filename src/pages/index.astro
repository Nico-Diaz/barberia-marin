---
import Layout from '../layouts/Layout.astro';
import BookingSection from '../components/BookingSection.astro';
import { supabase } from '../lib/supabase';
import nodemailer from 'nodemailer';

let mensajeError = "";

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const nombre = formData.get('nombre') as string;
  const apellido = formData.get('apellido') as string;
  const fecha = formData.get('fecha') as string;
  const hora = formData.get('hora') as string;
  const telefono = formData.get('telefono') as string;
  const servicioId = formData.get('servicio') as string;

  const diaSemana = new Date(fecha + 'T00:00:00').getDay();

  try {
    // 1. VALIDAR SERVICIO
    const { data: servicioEncontrado, error: errorServicio } = await supabase
        .from('servicios')
        .select('*')
        .eq('id', servicioId)
        .single();

    if (errorServicio || !servicioEncontrado) {
        throw { message: "Por favor, seleccione un servicio v치lido." };
    }
    const nombreServicio = servicioEncontrado.nombre;

    // --- CORRECCI칍N DE ZONA HORARIA (ARGENTINA UTC-3) ---
    const fechaGlobal = new Date();
    // Restamos 3 horas (3 * 60 minutos * 60 segundos * 1000 milisegundos)
    const ahoraArgentina = new Date(fechaGlobal.getTime() - (3 * 60 * 60 * 1000));

    // Usamos esta fecha ajustada para calcular el "HOY"
    const fechaHoyStr = ahoraArgentina.toISOString().split('T')[0];
    
    // 2. VALIDACI칍N FECHA PASADA
    if (fecha < fechaHoyStr) throw { message: "No puedes reservar en el pasado." };
    
    // Validaci칩n de hora exacta si el turno es HOY
    if (fecha === fechaHoyStr) {
        // Usamos getUTCHours porque ya "movimos" el tiempo 3 horas atr치s manualmente
        const horaActual = ahoraArgentina.getUTCHours();
        const minActual = ahoraArgentina.getUTCMinutes();
        
        const [hTurno, mTurno] = hora.split(':').map(Number);
        
        // Comparamos
        if (hTurno < horaActual || (hTurno === horaActual && mTurno < minActual)) {
             throw { message: "Ese horario ya pas칩 (hora local)." };
        }
    }

    // 3. VALIDACI칍N D칈AS Y HORARIOS
    let esHorarioValido = false;
    let inicioStr = ""; let finStr = ""; let mensajeRango = "";

    const { data: reglaDia } = await supabase.from('dias_especiales').select('*').eq('fecha', fecha).single();

    if (reglaDia) {
        if (reglaDia.cerrado) mensajeError = "Lo sentimos, este d칤a la barber칤a permanecer치 cerrada.";
        else { 
            inicioStr = reglaDia.hora_inicio; 
            finStr = reglaDia.hora_fin; 
            mensajeRango = `Horario especial: ${inicioStr} a ${finStr}hs.`; 
        }
    } else {
        if (diaSemana === 0) mensajeError = "Domingos cerrado.";
        else if ([1, 3, 5].includes(diaSemana)) { inicioStr = "10:00"; finStr = "19:00"; mensajeRango = "Lun, Mie, Vie: 10 a 19hs."; } 
        else if ([2, 4].includes(diaSemana)) { inicioStr = "10:00"; finStr = "20:00"; mensajeRango = "Mar, Jue: 10 a 20hs."; } 
        else if (diaSemana === 6) { inicioStr = "11:00"; finStr = "21:00"; mensajeRango = "S치bados: 11 a 21hs."; }
    }

    if (!mensajeError && inicioStr && finStr) {
        if (hora >= inicioStr && hora < finStr) esHorarioValido = true;
        else mensajeError = mensajeRango;
    }

    if (esHorarioValido && !mensajeError) {
        // 4. CHEQUEAR DUPLICADOS
        const { data: turnosExistentes } = await supabase.from('turnos').select('*').eq('fecha', fecha).eq('hora', hora);
        if (turnosExistentes && turnosExistentes.length > 0) throw { message: `El horario de las ${hora} ya est치 ocupado.` };

        // 5. GUARDAR TURNO
        const { error: errorInsert } = await supabase.from('turnos').insert([{ 
            nombre, apellido, fecha, hora, telefono, servicio: nombreServicio 
        }]);
        if (errorInsert) throw errorInsert;

        // 6. ENVIAR EMAIL
        try {
            const transporter = nodemailer.createTransport({ 
                service: 'gmail', 
                auth: { user: import.meta.env.GMAIL_USER, pass: import.meta.env.GMAIL_PASS } 
            });

            await transporter.sendMail({
                from: `"Barber칤a Web" <${import.meta.env.GMAIL_USER}>`,
                to: import.meta.env.GMAIL_USER,
                subject: `游댒 Nuevo Turno: ${nombre} ${apellido}`,
                html: `<div style="font-family: sans-serif; padding: 20px; border: 1px solid #ccc; border-radius: 10px;">
                    <h2 style="color: #d4af37;">춰Nuevo Turno!</h2>
                    <ul>
                        <li><strong>Cliente:</strong> ${nombre} ${apellido}</li>
                        <li><strong>Servicio:</strong> ${nombreServicio}</li>
                        <li><strong>Fecha:</strong> ${fecha}</li>
                        <li><strong>Hora:</strong> ${hora} hs</li>
                        <li><strong>WhatsApp:</strong> <a href="https://wa.me/${telefono}">${telefono}</a></li>
                    </ul>
                </div>`
            });
        } catch (e) { console.error("Error email:", e); }
            
        return Astro.redirect(`/exito?nombre=${nombre}&fecha=${fecha}&hora=${hora}`);
    }

  } catch (error: any) {
    console.error(error);
    mensajeError = error.message || "Error al procesar el turno.";
  }
}
---

<Layout title="Reservar Turno | Ezequiel Marin">
    <main class="app-wrapper">
        <div class="brand-header">
            <h1>BARBER칈A EZEQUIEL MARIN</h1>
            <p>Reserva tu lugar exclusivo</p>
        </div>

        <BookingSection errorBackend={mensajeError} />
        
        <footer class="mini-footer">
            <p>춸 2024 Ezequiel Marin</p>
            <a href="/login" class="admin-link">游</a>
        </footer>
    </main>
</Layout>

<style>
    .app-wrapper { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: #121212; padding: 20px; font-family: 'Montserrat', sans-serif; }
    .brand-header { text-align: center; margin-bottom: 30px; color: #d4af37; }
    .brand-header h1 { font-family: 'Bebas Neue', sans-serif; font-size: 2.5rem; letter-spacing: 2px; margin: 0; }
    .brand-header p { font-size: 0.9rem; opacity: 0.7; margin-top: 5px; text-transform: uppercase; letter-spacing: 1px; color: #fff; }
    .mini-footer { margin-top: 40px; text-align: center; color: rgba(242, 240, 230, 0.3); font-size: 0.8rem; }
    .admin-link { text-decoration: none; color: inherit; font-size: 0.8rem; margin-top: 5px; display: inline-block; opacity: 0.5; }
</style>