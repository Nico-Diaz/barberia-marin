---
// Lógica del Servidor (Backend)
import { db, Turnos, eq, and } from 'astro:db';

let mensaje = "";
let tipoMensaje = ""; // 'exito' o 'error'

// Si el método es POST (alguien envió el formulario)
if (Astro.request.method === 'POST') {
  // 1. Obtener los datos del formulario
  const formData = await Astro.request.formData();
  const nombre = formData.get('nombre') as string;
  const apellido = formData.get('apellido') as string;
  const fecha = formData.get('fecha') as string;
  const hora = formData.get('hora') as string;
  const telefono = formData.get('telefono') as string;

  try {
    // 2. VERIFICACIÓN: ¿Ya existe un turno ese día a esa hora?
    const turnosExistentes = await db.select().from(Turnos).where(
        and(
            eq(Turnos.fecha, fecha),
            eq(Turnos.hora, hora)
        )
    );

    if (turnosExistentes.length > 0) {
        // CASO: OCUPADO
        mensaje = `Lo sentimos, el horario de las ${hora} para el día ${fecha} ya está ocupado. Por favor elige otro.`;
        tipoMensaje = "error";
    } else {
        // CASO: DISPONIBLE -> Guardamos
        await db.insert(Turnos).values({
            nombre,
            apellido,
            fecha,
            hora,
            telefono
        });
        mensaje = "¡Reserva confirmada con éxito! Te esperamos.";
        tipoMensaje = "exito";
    }

  } catch (error) {
    console.error("Error al guardar turno:", error);
    mensaje = "Ocurrió un error en el sistema. Intenta nuevamente.";
    tipoMensaje = "error";
  }
}
---

<section id="booking" class="booking-section section-padding">
    <div class="container">
        <h2>AGENDA TU TURNO</h2>
        <p class="subtitle">La excelencia requiere tiempo. Reserva tu espacio exclusivo.</p>
        
        <div class="booking-container">
            
            {mensaje && (
                <div class={`mensaje-alerta ${tipoMensaje}`}>
                    {mensaje}
                </div>
            )}

            <form method="POST" class="booking-form">
                <div class="form-group">
                    <input type="text" name="nombre" placeholder="Nombre" required>
                    <input type="text" name="apellido" placeholder="Apellido" required>
                </div>
                
                <div class="form-group">
                    <input type="tel" name="telefono" placeholder="Teléfono / WhatsApp">
                </div>

                <div class="form-group">
                    <label class="fecha-label">
                        <span>Selecciona el día:</span>
                        <input type="date" name="fecha" required min={new Date().toISOString().split('T')[0]}>
                    </label>
                    
                    <label class="hora-label">
                        <span>Selecciona la hora:</span>
                        <select name="hora" required>
                            <option value="" disabled selected>Hora...</option>
                            <option value="10:00">10:00</option>
                            <option value="11:00">11:00</option>
                            <option value="12:00">12:00</option>
                            <option value="13:00">13:00</option>
                            <option value="14:00">14:00</option>
                            <option value="15:00">15:00</option>
                            <option value="16:00">16:00</option>
                            <option value="17:00">17:00</option>
                            <option value="18:00">18:00</option>
                            <option value="19:00">19:00</option>
                            <option value="20:00">20:00</option>
                        </select>
                    </label>
                </div>

                <button type="submit" class="btn btn-submit">CONFIRMAR RESERVA</button>
            </form>
        </div>
    </div>
</section>

<style>
    .booking-section {
        background-color: var(--color-text-black);
        color: var(--color-bg-beige);
        text-align: center;
    }

    h2 {
        font-size: 3rem;
        margin-bottom: 10px;
        color: var(--color-bg-beige);
    }

    .subtitle {
        font-size: 1.1rem;
        opacity: 0.8;
        margin-bottom: 40px;
    }
    
    .booking-container {
        max-width: 600px;
        margin: 0 auto;
        background-color: rgba(255,255,255, 0.05);
        padding: 40px;
        border-radius: 8px;
        border: 1px solid rgba(242, 240, 230, 0.1);
    }

    /* Estilos de los mensajes */
    .mensaje-alerta {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
        font-weight: 600;
    }
    .mensaje-alerta.exito {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .mensaje-alerta.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .form-group {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    /* Etiquetas para mejorar la UX de fecha/hora */
    .fecha-label, .hora-label {
        display: flex;
        flex-direction: column;
        text-align: left;
        width: 100%;
        color: rgba(242, 240, 230, 0.8);
        font-size: 0.9rem;
    }
    .fecha-label span, .hora-label span {
        margin-bottom: 5px;
        margin-left: 2px;
    }

    /* Input Styles */
    input, select {
        width: 100%;
        padding: 15px;
        background-color: transparent;
        border: 1px solid rgba(242, 240, 230, 0.3);
        color: var(--color-bg-beige);
        font-family: var(--font-body);
        font-size: 1rem;
        border-radius: 4px;
        outline: none;
    }

    input:focus, select:focus {
        border-color: var(--color-bg-beige);
        background-color: rgba(255,255,255, 0.05);
    }

    /* Hack para el calendario en navegadores oscuros */
    input[type="date"] {
        color-scheme: dark;
    }

    select option {
        background-color: #333;
        color: #fff;
    }

    .btn-submit {
        width: 100%;
        margin-top: 10px;
        background-color: var(--color-bg-beige);
        color: var(--color-text-black);
        border: none;
        font-weight: 700;
    }

    .btn-submit:hover {
        background-color: #fff;
        transform: scale(1.02);
    }

    @media (max-width: 768px) {
        .form-group {
            flex-direction: column;
            gap: 20px;
        }
    }
</style>